<!DOCTYPE html>
<html lang="es" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reproductor Multimedia Pro</title>
    <!-- Tailwind CSS con Prefijo para evitar conflictos en Odoo -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Spline+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #0da6f2;
            --bg-dark: #101c22;
        }
        * { font-family: 'Inter', 'Spline Sans', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Scrollbars */
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }

        /* Animaciones y Estados */
        .glass { backdrop-filter: blur(20px); background: rgba(16, 28, 34, 0.85); }
        .speed-carousel { 
            display: flex; 
            overflow-x: auto; 
            scroll-snap-type: x mandatory; 
            scrollbar-width: none;
            cursor: grab;
        }
        .speed-carousel::-webkit-scrollbar { display: none; }
        .speed-tick { 
            flex: 0 0 40px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            scroll-snap-align: center; 
        }
        .speed-tick .line { width: 2px; background: #475569; transition: all 0.2s; }
        .speed-tick.active .line { background: var(--primary); height: 24px !important; }
        
        .seek-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(13, 166, 242, 0.9);
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .seek-indicator.show { opacity: 1; transform: translateY(-50%) scale(1.1); }

        .lyrics-line { opacity: 0.3; transition: all 0.4s ease; cursor: pointer; }
        .lyrics-line.active { opacity: 1; color: white; font-size: 1.2em; font-weight: 700; transform: translateX(10px); }

        /* Mobile Specifics */
        @media (max-width: 768px) {
            .mobile-popout {
                transform: translateY(100%);
                transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            }
            .mobile-popout.open { transform: translateY(0); }
        }

        .fill-1 { font-variation-settings: 'FILL' 1; }
    </style>
</head>
<body class="bg-[#101c22] text-white overflow-hidden">

    <div id="player-app" class="h-screen w-full flex flex-col relative">
        <!-- El contenido se genera dinámicamente -->
    </div>

    <script>
        (function() {
            const Player = {
                state: {
                    mode: 'minimized', // minimized, popout, fullscreen
                    isMobile: window.innerWidth <= 768,
                    paused: true,
                    currentTime: 0,
                    duration: 0,
                    volume: 0.7,
                    speed: 1.0,
                    repeat: 'off', // off, one, all
                    panelOpen: false,
                    panelTab: 'info',
                    subtitlesEnabled: false,
                    activeLyricIndex: -1,
                    seekAccumulator: 0,
                    seekTimeout: null,
                    timer: null, // { type: 'countdown'|'end', value: ms }
                    episode: {
                        id: 'default',
                        title: 'Cargando...',
                        author: '...',
                        cover: 'https://picsum.photos/400/400',
                        mp3: '',
                        mp4: '',
                        gender: 'podcast', // podcast, music, false
                        description: '',
                        lyrics: []
                    }
                },

                elements: {
                    audio: new Audio(),
                    video: document.createElement('video'),
                    app: document.getElementById('player-app')
                },

                init() {
                    this.setupMedia();
                    this.loadPersistedState();
                    this.render();
                    this.attachGlobalEvents();
                    this.updateLoop();
                },

                setupMedia() {
                    this.elements.audio.preload = "metadata";
                    this.elements.video.playsInline = true;
                    
                    const events = ['timeupdate', 'durationchange', 'ended', 'play', 'pause'];
                    events.forEach(ev => {
                        this.elements.audio.addEventListener(ev, () => this.handleMediaEvent(ev));
                        this.elements.video.addEventListener(ev, () => this.handleMediaEvent(ev));
                    });
                },

                handleMediaEvent(ev) {
                    const media = this.getActiveMedia();
                    if (ev === 'timeupdate') {
                        this.state.currentTime = media.currentTime;
                        this.syncUIProgress();
                        this.checkLyrics();
                    }
                    if (ev === 'durationchange') this.state.duration = media.duration;
                    if (ev === 'ended') this.handleEnded();
                    if (ev === 'play') this.state.paused = false;
                    if (ev === 'pause') this.state.paused = true;
                    this.updatePlayIcons();
                },

                getActiveMedia() {
                    return (this.state.mode === 'popout' && this.state.episode.mp4 && !this.state.isAudioMode) 
                           ? this.elements.video 
                           : this.elements.audio;
                },

                // --- LÓGICA DE NEGOCIO ---
                
                loadEpisode(ep, autoplay = true) {
                    this.state.episode = { ...this.state.episode, ...ep };
                    this.elements.audio.src = ep.mp3 || '';
                    this.elements.video.src = ep.mp4 || '';
                    this.state.currentTime = 0;
                    this.state.activeLyricIndex = -1;
                    
                    if (autoplay) this.play();
                    this.render();
                },

                play() {
                    this.getActiveMedia().play().catch(e => console.log("Autoplay blocked"));
                    this.state.paused = false;
                },

                pause() {
                    this.getActiveMedia().pause();
                    this.state.paused = true;
                },

                togglePlay() {
                    this.state.paused ? this.play() : this.pause();
                },

                seekBy(seconds) {
                    const media = this.getActiveMedia();
                    clearTimeout(this.state.seekTimeout);
                    
                    this.state.seekAccumulator += seconds;
                    const indicatorId = seconds > 0 ? 'seek-right' : 'seek-left';
                    const el = document.getElementById(indicatorId);
                    if (el) {
                        el.querySelector('.val').innerText = `${Math.abs(this.state.seekAccumulator)}s`;
                        el.classList.add('show');
                    }

                    this.state.seekTimeout = setTimeout(() => {
                        media.currentTime += this.state.seekAccumulator;
                        this.state.seekAccumulator = 0;
                        if (el) el.classList.remove('show');
                    }, 500);
                },

                setSpeed(val) {
                    this.state.speed = parseFloat(val);
                    this.elements.audio.playbackRate = this.state.speed;
                    this.elements.video.playbackRate = this.state.speed;
                    const btn = document.getElementById('speed-display-btn');
                    if (btn) btn.innerText = `${this.state.speed.toFixed(1)}x`;
                },

                // --- UI RENDER ---

                render() {
                    if (this.state.isMobile) {
                        this.renderMobile();
                    } else {
                        this.renderDesktop();
                    }
                    this.updatePlayIcons();
                    this.updateDynamicBg();
                },

                renderDesktop() {
                    const ep = this.state.episode;
                    const isAudio = this.state.mode === 'popout' && this.state.panelTab === 'info' && ep.gender !== 'false';

                    this.elements.app.innerHTML = `
                        <div class="flex-1 flex flex-col relative overflow-hidden">
                            <!-- Popout Area -->
                            <div id="main-view" class="flex-1 flex transition-all duration-500 ${this.state.mode === 'popout' ? 'translate-y-0' : 'translate-y-full'}">
                                <div id="media-container" class="flex-1 flex relative bg-black/20">
                                    ${this.renderDesktopMediaLayout()}
                                </div>
                                
                                <!-- Side Panel -->
                                <div id="side-panel" class="transition-all duration-300 border-l border-white/10 glass" 
                                     style="width: ${this.state.panelOpen ? '400px' : '0px'}; opacity: ${this.state.panelOpen ? 1 : 0}">
                                    ${this.renderPanel()}
                                </div>
                            </div>

                            <!-- Bottom Bar -->
                            <div class="h-24 glass border-t border-white/10 px-6 flex items-center justify-between z-50">
                                ${this.renderBottomBar()}
                            </div>
                        </div>

                        <!-- Seek Indicators -->
                        <div id="seek-left" class="seek-indicator left-20"><span class="material-symbols-outlined">replay_10</span> <span class="val">0s</span></div>
                        <div id="seek-right" class="seek-indicator right-20"><span class="material-symbols-outlined">forward_10</span> <span class="val">0s</span></div>
                    `;
                    this.attachEvents();
                },

                renderDesktopMediaLayout() {
                    const ep = this.state.episode;
                    // Si es modo audio y panel info abierto -> Cover Izquierda, Letras Derecha
                    if (this.state.mode === 'popout' && this.state.panelTab === 'info' && ep.gender !== 'false') {
                        return `
                            <div class="flex w-full h-full p-12 gap-12 items-center">
                                <div class="w-1/3 flex justify-center">
                                    <img src="${ep.cover}" class="w-80 h-80 object-cover rounded-2xl shadow-2xl ring-8 ring-white/5">
                                </div>
                                <div class="flex-1 h-full overflow-y-auto custom-scroll flex flex-col justify-center" id="lyrics-scroll">
                                    ${this.renderLyrics()}
                                </div>
                            </div>
                        `;
                    }
                    // Layout normal (Video o Cover centrado)
                    return `
                        <div class="flex-1 flex items-center justify-center p-8">
                            ${ep.mp4 ? `<video id="video-player" src="${ep.mp4}" class="max-h-full rounded-lg shadow-2xl"></video>` : `<img src="${ep.cover}" class="max-h-full rounded-lg shadow-2xl">`}
                        </div>
                    `;
                },

                renderMobile() {
                    const ep = this.state.episode;
                    this.elements.app.innerHTML = `
                        <!-- Mobile Bar (Fixed Bottom) -->
                        <div class="fixed bottom-0 left-0 right-0 h-16 glass border-t border-white/10 flex items-center px-4 gap-3 z-40" id="mobile-min-bar">
                            <img src="${ep.cover}" class="w-10 h-10 rounded object-cover">
                            <div class="flex-1 min-w-0">
                                <div class="text-sm font-bold truncate">${ep.title}</div>
                                <div class="text-[10px] text-white/50 uppercase tracking-widest">${ep.author}</div>
                            </div>
                            <button onclick="Player.togglePlay()" class="p-2"><span class="material-symbols-outlined text-3xl play-icon">play_arrow</span></button>
                            <button id="btn-open-popout" class="p-2"><span class="material-symbols-outlined text-3xl">expand_less</span></button>
                        </div>

                        <!-- Mobile Popout (Full Screen) -->
                        <div id="mobile-popout" class="mobile-popout fixed inset-0 bg-[#101c22] z-50 flex flex-col p-6 overflow-y-auto">
                            <header class="flex justify-between items-center mb-6">
                                <button id="btn-close-popout"><span class="material-symbols-outlined text-3xl">expand_more</span></button>
                                <div class="bg-white/10 rounded-full p-1 flex text-[10px] font-bold uppercase">
                                    <button class="px-4 py-1 rounded-full bg-white/20">Video</button>
                                    <button class="px-4 py-1 rounded-full">Audio</button>
                                </div>
                                <button onclick="Player.togglePanel('info')"><span class="material-symbols-outlined">more_horiz</span></button>
                            </header>

                            <div class="flex-1 flex flex-col items-center justify-center">
                                <div class="w-full aspect-square rounded-3xl overflow-hidden shadow-2xl mb-8" id="mobile-media-box">
                                    <img src="${ep.cover}" class="w-full h-full object-cover">
                                </div>
                                
                                <div class="w-full flex justify-between items-center mb-8">
                                    <div class="min-w-0">
                                        <h1 class="text-2xl font-bold truncate">${ep.title}</h1>
                                        <p class="text-white/50">${ep.author}</p>
                                    </div>
                                    <button onclick="Player.toggleFav()"><span class="material-symbols-outlined text-3xl">favorite</span></button>
                                </div>

                                <!-- Progress -->
                                <div class="w-full mb-8">
                                    <input type="range" class="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer accent-primary" id="mobile-progress">
                                    <div class="flex justify-between text-[10px] mt-2 text-white/40 font-mono">
                                        <span id="m-time-cur">0:00</span>
                                        <span id="m-time-total">0:00</span>
                                    </div>
                                </div>

                                <!-- Controls -->
                                <div class="w-full flex justify-between items-center mb-10">
                                    <button class="text-xs font-bold border border-white/20 rounded px-2 py-1" onclick="Player.togglePanel('speed')">1.0x</button>
                                    <div class="flex items-center gap-6">
                                        <button onclick="Player.seekBy(-15)"><span class="material-symbols-outlined text-3xl">replay_10</span></button>
                                        <button onclick="Player.togglePlay()" class="w-20 h-20 bg-white text-black rounded-full flex items-center justify-center">
                                            <span class="material-symbols-outlined text-5xl play-icon">play_arrow</span>
                                        </button>
                                        <button onclick="Player.seekBy(15)"><span class="material-symbols-outlined text-3xl">forward_10</span></button>
                                    </div>
                                    <button><span class="material-symbols-outlined">repeat</span></button>
                                </div>

                                <!-- Actions -->
                                <div class="w-full flex justify-around text-white/60">
                                    <button onclick="Player.togglePanel('timer')"><span class="material-symbols-outlined">timer</span></button>
                                    <button onclick="Player.toggleSubtitles()"><span class="material-symbols-outlined">closed_caption</span></button>
                                    <button onclick="Player.togglePanel('queue')"><span class="material-symbols-outlined">queue_music</span></button>
                                    <button><span class="material-symbols-outlined">share</span></button>
                                </div>
                            </div>
                        </div>
                    `;
                    this.attachMobileEvents();
                },

                renderBottomBar() {
                    const ep = this.state.episode;
                    return `
                        <div class="flex items-center gap-4 w-1/3">
                            <img src="${ep.cover}" class="w-14 h-14 rounded-lg object-cover shadow-lg cursor-pointer" onclick="Player.toggleMode()">
                            <div class="min-w-0">
                                <div class="font-bold truncate text-sm">${ep.title}</div>
                                <div class="text-xs text-white/50 truncate">${ep.author}</div>
                            </div>
                        </div>

                        <div class="flex flex-col items-center w-1/3 gap-2">
                            <div class="flex items-center gap-6">
                                <button onclick="Player.setSpeed(1.0)" id="speed-display-btn" class="text-[10px] font-bold border border-white/20 rounded px-1.5">1.0x</button>
                                <button onclick="Player.previous()"><span class="material-symbols-outlined">skip_previous</span></button>
                                <button onclick="Player.seekBy(-15)"><span class="material-symbols-outlined">replay_10</span></button>
                                <button onclick="Player.togglePlay()" class="w-12 h-12 bg-white text-black rounded-full flex items-center justify-center hover:scale-110 transition">
                                    <span class="material-symbols-outlined text-3xl play-icon">play_arrow</span>
                                </button>
                                <button onclick="Player.seekBy(15)"><span class="material-symbols-outlined">forward_10</span></button>
                                <button onclick="Player.next()"><span class="material-symbols-outlined">skip_next</span></button>
                                <button onclick="Player.cycleRepeat()"><span class="material-symbols-outlined">repeat</span></button>
                            </div>
                            <div class="w-full flex items-center gap-3">
                                <span class="text-[10px] font-mono text-white/40" id="d-time-cur">0:00</span>
                                <div class="flex-1 h-1 bg-white/10 rounded-full relative group cursor-pointer" id="d-progress-bg">
                                    <div class="absolute h-full bg-primary rounded-full" id="d-progress-fill" style="width: 0%"></div>
                                </div>
                                <span class="text-[10px] font-mono text-white/40" id="d-time-total">0:00</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-end gap-4 w-1/3">
                            <button onclick="Player.togglePanel('info')"><span class="material-symbols-outlined">lyrics</span></button>
                            <button onclick="Player.togglePanel('timer')"><span class="material-symbols-outlined">timer</span></button>
                            <button onclick="Player.togglePanel('queue')"><span class="material-symbols-outlined">queue_music</span></button>
                            <div class="flex items-center gap-2 group">
                                <span class="material-symbols-outlined text-white/50">volume_up</span>
                                <input type="range" class="w-20 h-1 accent-primary" oninput="Player.setVolume(this.value)" value="${this.state.volume}" min="0" max="1" step="0.1">
                            </div>
                            <button onclick="Player.toggleMode()"><span class="material-symbols-outlined">picture_in_picture_alt</span></button>
                        </div>
                    `;
                },

                renderPanel() {
                    const tab = this.state.panelTab;
                    const ep = this.state.episode;
                    
                    let title = "Opciones";
                    if (tab === 'info') {
                        title = ep.gender === 'music' ? 'Letra' : ep.gender === 'podcast' ? 'Transcripción' : 'Información';
                    } else if (tab === 'speed') title = "Velocidad";
                    else if (tab === 'timer') title = "Temporizador";

                    return `
                        <div class="h-full flex flex-col p-6">
                            <div class="flex justify-between items-center mb-8">
                                <h2 class="text-xl font-bold">${title}</h2>
                                <button onclick="Player.closePanel()"><span class="material-symbols-outlined">close</span></button>
                            </div>
                            <div class="flex-1 overflow-y-auto custom-scroll">
                                ${this.renderPanelContent()}
                            </div>
                        </div>
                    `;
                },

                renderPanelContent() {
                    const tab = this.state.panelTab;
                    if (tab === 'speed') {
                        return `
                            <div class="py-10">
                                <div class="relative h-20 flex items-center justify-center overflow-hidden">
                                    <div class="absolute top-0 w-0.5 h-full bg-primary z-10"></div>
                                    <div class="speed-carousel w-full h-full items-center" id="speed-carousel">
                                        <!-- Ticks generated by JS -->
                                    </div>
                                </div>
                                <div class="flex justify-center gap-4 mt-8">
                                    ${[1.0, 1.2, 1.5, 2.0].map(v => `<button onclick="Player.setSpeed(${v})" class="px-4 py-2 bg-white/10 rounded-full text-xs">${v}x</button>`).join('')}
                                </div>
                            </div>
                        `;
                    }
                    if (tab === 'timer') {
                        return `
                            <div class="space-y-4">
                                ${[5, 15, 30, 60].map(m => `
                                    <button onclick="Player.setTimer(${m})" class="w-full p-4 bg-white/5 hover:bg-white/10 rounded-xl text-left flex justify-between">
                                        <span>${m} minutos</span>
                                        <span class="material-symbols-outlined">chevron_right</span>
                                    </button>
                                `).join('')}
                                <button onclick="Player.setTimer('end')" class="w-full p-4 bg-primary/20 border border-primary/30 rounded-xl text-left flex justify-between">
                                    <span>Fin del episodio</span>
                                    <span class="material-symbols-outlined">timer</span>
                                </button>
                                <div id="timer-status" class="text-center py-4 text-primary font-bold"></div>
                            </div>
                        `;
                    }
                    if (tab === 'info') {
                        if (this.state.episode.gender === 'false') return `<p class="text-white/60">${this.state.episode.description}</p>`;
                        return `<div class="space-y-6">${this.renderLyrics()}</div>`;
                    }
                    return `<p class="text-center text-white/20 mt-20">Próximamente...</p>`;
                },

                renderLyrics() {
                    if (!this.state.episode.lyrics || this.state.episode.lyrics.length === 0) {
                        return `<p class="text-white/20 italic">No hay contenido disponible.</p>`;
                    }
                    return this.state.episode.lyrics.map((l, i) => `
                        <div class="lyrics-line ${i === this.state.activeLyricIndex ? 'active' : ''}" 
                             onclick="Player.seekTo(${l.start})">
                            ${l.text}
                        </div>
                    `).join('');
                },

                // --- LÓGICA DE APOYO ---

                updateLoop() {
                    setInterval(() => {
                        this.updateTimerStatus();
                    }, 1000);
                },

                updateTimerStatus() {
                    const statusEl = document.getElementById('timer-status');
                    if (!this.state.timer) {
                        if (statusEl) statusEl.innerText = "";
                        return;
                    }

                    let remaining = 0;
                    if (this.state.timer.type === 'end') {
                        remaining = this.state.duration - this.state.currentTime;
                    } else {
                        remaining = (this.state.timer.value - Date.now()) / 1000;
                    }

                    if (remaining <= 0) {
                        this.pause();
                        this.state.timer = null;
                    } else if (statusEl) {
                        const m = Math.floor(remaining / 60);
                        const s = Math.floor(remaining % 60);
                        statusEl.innerText = `Apagado en: ${m}:${s.toString().padStart(2, '0')}`;
                    }
                },

                setTimer(val) {
                    if (val === 'end') {
                        this.state.timer = { type: 'end' };
                    } else {
                        this.state.timer = { type: 'countdown', value: Date.now() + (val * 60 * 1000) };
                    }
                    this.render();
                },

                syncUIProgress() {
                    const p = (this.state.currentTime / this.state.duration) * 100 || 0;
                    const fill = document.getElementById('d-progress-fill');
                    if (fill) fill.style.width = `${p}%`;
                    
                    const cur = document.getElementById('d-time-cur');
                    if (cur) cur.innerText = this.formatTime(this.state.currentTime);
                    
                    const tot = document.getElementById('d-time-total');
                    if (tot) tot.innerText = this.formatTime(this.state.duration);

                    // Mobile sync
                    const mProg = document.getElementById('mobile-progress');
                    if (mProg) mProg.value = p;
                },

                formatTime(s) {
                    const m = Math.floor(s / 60);
                    const sec = Math.floor(s % 60);
                    return `${m}:${sec.toString().padStart(2, '0')}`;
                },

                updatePlayIcons() {
                    const icons = document.querySelectorAll('.play-icon');
                    icons.forEach(i => i.innerText = this.state.paused ? 'play_arrow' : 'pause');
                },

                toggleMode() {
                    this.state.mode = this.state.mode === 'minimized' ? 'popout' : 'minimized';
                    this.render();
                },

                togglePanel(tab) {
                    if (this.state.panelOpen && this.state.panelTab === tab) {
                        this.state.panelOpen = false;
                    } else {
                        this.state.panelOpen = true;
                        this.state.panelTab = tab;
                    }
                    this.render();
                    if (tab === 'speed') this.initSpeedCarousel();
                },

                closePanel() {
                    this.state.panelOpen = false;
                    this.render();
                },

                initSpeedCarousel() {
                    const carousel = document.getElementById('speed-carousel');
                    if (!carousel) return;

                    const speeds = [];
                    for (let i = 0.5; i <= 2.0; i += 0.1) speeds.push(parseFloat(i.toFixed(1)));

                    carousel.innerHTML = speeds.map(s => `
                        <div class="speed-tick ${s === this.state.speed ? 'active' : ''}" data-speed="${s}">
                            <div class="line h-4 w-0.5"></div>
                            <span class="text-[8px] mt-2 ${s % 0.5 === 0 ? 'opacity-100' : 'opacity-0'}">${s}</span>
                        </div>
                    `).join('');

                    // Centrar el valor actual
                    const activeTick = carousel.querySelector('.active');
                    if (activeTick) {
                        carousel.scrollLeft = activeTick.offsetLeft - (carousel.offsetWidth / 2) + (activeTick.offsetWidth / 2);
                    }

                    carousel.onscroll = () => {
                        const centerX = carousel.scrollLeft + (carousel.offsetWidth / 2);
                        let closest = null;
                        let minDiff = Infinity;

                        carousel.querySelectorAll('.speed-tick').forEach(tick => {
                            const diff = Math.abs((tick.offsetLeft + tick.offsetWidth / 2) - centerX);
                            if (diff < minDiff) {
                                minDiff = diff;
                                closest = tick;
                            }
                        });

                        if (closest) {
                            const newSpeed = closest.dataset.speed;
                            if (newSpeed != this.state.speed) {
                                this.setSpeed(newSpeed);
                                carousel.querySelectorAll('.speed-tick').forEach(t => t.classList.remove('active'));
                                closest.classList.add('active');
                            }
                        }
                    };
                },

                updateDynamicBg() {
                    // Simulación de color dinámico basado en cover
                    const color = this.state.mode === 'popout' ? 'rgba(13, 166, 242, 0.15)' : 'transparent';
                    document.body.style.background = `radial-gradient(circle at bottom, ${color} 0%, #101c22 100%)`;
                },

                attachEvents() {
                    const progBg = document.getElementById('d-progress-bg');
                    if (progBg) {
                        progBg.onclick = (e) => {
                            const rect = progBg.getBoundingClientRect();
                            const pct = (e.clientX - rect.left) / rect.width;
                            this.getActiveMedia().currentTime = pct * this.state.duration;
                        };
                    }
                },

                attachMobileEvents() {
                    const btnOpen = document.getElementById('btn-open-popout');
                    const btnClose = document.getElementById('btn-close-popout');
                    const popout = document.getElementById('mobile-popout');

                    if (btnOpen) btnOpen.onclick = () => popout.classList.add('open');
                    if (btnClose) btnClose.onclick = () => popout.classList.remove('open');

                    // Gestos básicos
                    let touchStartY = 0;
                    popout?.addEventListener('touchstart', e => touchStartY = e.touches[0].clientY);
                    popout?.addEventListener('touchend', e => {
                        const diff = e.changedTouches[0].clientY - touchStartY;
                        if (diff > 100) popout.classList.remove('open');
                    });
                },

                attachGlobalEvents() {
                    window.onresize = () => {
                        const isMob = window.innerWidth <= 768;
                        if (isMob !== this.state.isMobile) {
                            this.state.isMobile = isMob;
                            this.render();
                        }
                    };
                },

                checkLyrics() {
                    if (!this.state.episode.lyrics) return;
                    const idx = this.state.episode.lyrics.findIndex(l => 
                        this.state.currentTime >= l.start && 
                        (!this.state.episode.lyrics[this.state.episode.lyrics.indexOf(l)+1] || 
                         this.state.currentTime < this.state.episode.lyrics[this.state.episode.lyrics.indexOf(l)+1].start)
                    );
                    
                    if (idx !== this.state.activeLyricIndex) {
                        this.state.activeLyricIndex = idx;
                        const scroll = document.getElementById('lyrics-scroll');
                        if (scroll) {
                            const active = scroll.querySelectorAll('.lyrics-line')[idx];
                            if (active) active.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        this.renderLyricsInView();
                    }
                },

                renderLyricsInView() {
                    const container = document.getElementById('lyrics-scroll');
                    if (container) container.innerHTML = this.renderLyrics();
                },

                loadPersistedState() {
                    const saved = localStorage.getItem('player_pro_state');
                    if (saved) {
                        const data = JSON.parse(saved);
                        this.state.volume = data.volume || 0.7;
                        this.state.speed = data.speed || 1.0;
                    }
                },

                saveState() {
                    localStorage.setItem('player_pro_state', JSON.stringify({
                        volume: this.state.volume,
                        speed: this.state.speed
                    }));
                }
            };

            // Exponer API
            window.PlayerAPI = {
                loadEpisode: (ep) => Player.loadEpisode(ep),
                play: () => Player.play(),
                pause: () => Player.pause(),
                toggle: () => Player.togglePlay()
            };

            Player.init();

            // Ejemplo inicial
            setTimeout(() => {
                PlayerAPI.loadEpisode({
                    title: 'El futuro de la IA Generativa',
                    author: 'The New York Times',
                    cover: 'https://picsum.photos/600/600?random=12',
                    mp3: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
                    gender: 'podcast',
                    lyrics: [
                        { start: 0, text: "Bienvenidos al especial de tecnología." },
                        { start: 5, text: "Hoy analizamos el impacto de los modelos de lenguaje." },
                        { start: 10, text: "Desde GPT-4 hasta las nuevas fronteras de la robótica." },
                        { start: 15, text: "La interfaz del futuro no será una pantalla, será una conversación." }
                    ]
                });
            }, 500);
        })();
    </script>
</body>
</html>

<!-- Ejemplo de cómo llamar al reproductor desde Odoo -->
<script>
    // Supongamos que tienes los datos del backend de Odoo
    const datosOdoo = {
        id: '123',
        titulo: 'Mi Podcast en Odoo',
        autor: 'Departamento de Marketing',
        url_audio: 'https://tuservidor.com/audio.mp3',
        url_portada: 'https://tuservidor.com/portada.jpg',
        tipo: 'podcast' // o 'music'
    };

    // Llamada a la API del reproductor
    if (window.PlayerAPI) {
        window.PlayerAPI.loadEpisode({
            id: datosOdoo.id,
            title: datosOdoo.titulo,
            author: datosOdoo.autor,
            mp3: datosOdoo.url_audio,
            cover: datosOdoo.url_portada,
            gender: datosOdoo.tipo,
            lyrics: [
                { start: 0, text: "Inicio de la transcripción automática..." },
                { start: 10, text: "Punto clave del episodio." }
            ]
        });
    }
</script>
