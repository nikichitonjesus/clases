<!DOCTYPE html>
<html lang="es" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Reproductor Profesional (Escritorio + Móvil)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0,1" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Inter', sans-serif; }
    /* Utilidades generales */
    .volume-hover:hover .volume-slider { width: 80px; opacity: 1; }
    .volume-slider { width: 0; opacity: 0; transition: all 0.2s; }
    .progress-thumb { opacity: 0; transition: opacity 0.2s; }
    .progress-container:hover .progress-thumb { opacity: 1; }
    .glass { backdrop-filter: blur(16px); background: rgba(0,0,0,0.3); }
    .glass-dark { backdrop-filter: blur(20px); background: rgba(16,28,34,0.9); }
    .seek-indicator { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.7); color: white; padding: 0.5rem 1rem; border-radius: 2rem; display: flex; align-items: center; gap: 0.5rem; z-index: 60; pointer-events: none; opacity: 0; transition: opacity 0.2s; }
    .seek-indicator.show { opacity: 1; }
    .fill-1 { font-variation-settings: 'FILL' 1; }
    /* Estilos para letra/transcripción en audio */
    .lyrics-container { height: 100%; overflow-y: auto; scroll-behavior: smooth; }
    .lyrics-line { transition: all 0.2s; }
    .lyrics-line.active { color: #0da6f2; font-weight: 600; transform: scale(1.02); }
    /* Carrusel de velocidad */
    .speed-carousel { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; }
    .speed-carousel::-webkit-scrollbar { display: none; }
    .speed-tick { flex: 0 0 20px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; scroll-snap-align: center; cursor: pointer; }
    .speed-tick .line { width: 1px; background: #b3b3b3; }
    .speed-tick.major .line { height: 20px; }
    .speed-tick.minor .line { height: 10px; }
    .speed-tick span { margin-top: 5px; font-size: 10px; }
    .speed-pointer { position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-top: 12px solid #0da6f2; z-index: 1; }
    /* Móvil: ocultar elementos de escritorio cuando corresponda */
    .desktop-only { display: flex; }
    .mobile-only { display: none; }
    @media (max-width: 768px) {
      .desktop-only { display: none; }
      .mobile-only { display: flex; }
    }
  </style>
</head>
<body class="bg-[#101c22] text-white min-h-screen flex flex-col relative overflow-hidden">
  <div id="player-root" class="relative flex-1 flex flex-col"></div>

  <script>
    (function() {
      // ---------- ESTADO GLOBAL ----------
      const PlayerState = {
        mode: 'minimized',           // minimized, popout-video, popout-audio, fullscreen
        episode: null,
        playlist: [],
        history: [],
        favorites: [],
        savedList: [],
        currentTime: 0,
        duration: 0,
        paused: true,
        volume: 0.7,
        speed: 1.0,
        repeat: 'off',
        shuffle: false,
        timer: null,                  // { endTime: timestamp, type: 'countdown'|'end', baseTime: ... }
        panelOpen: false,
        panelTab: 'queue',
        subtitlesEnabled: false,
        subtitlesTrack: null,
        lyricsLines: [],
        activeLyricIndex: -1,
        seekAccumulator: { back: 0, forward: 0, timeout: null }
      };

      const defaultEpisode = {
        id: 'ep_default',
        title: 'El futuro de la IA generativa',
        author: 'Tech Podcast',
        cover: 'https://picsum.photos/400/400?random=1',
        mp3: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3',
        mp4: 'https://commondatastorage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4',
        description: 'Exploramos cómo la inteligencia artificial está transformando el diseño y la creatividad.',
        detailsUrl: '#',
        subtitlesUrl: '',
        gender: 'podcast',             // 'music', 'podcast', 'false'
        serie: { title: 'Tech Talks', cover: '', episodes: [] }
      };

      // Utilidades
      const formatTime = (sec) => {
        if (isNaN(sec) || sec === Infinity) return '0:00';
        const h = Math.floor(sec / 3600);
        const m = Math.floor((sec % 3600) / 60);
        const s = Math.floor(sec % 60);
        return h > 0 ? `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}` : `${m}:${s.toString().padStart(2,'0')}`;
      };

      // Persistencia
      const saveState = () => {
        const toSave = {
          episode: PlayerState.episode,
          currentTime: PlayerState.currentTime,
          paused: PlayerState.paused,
          volume: PlayerState.volume,
          speed: PlayerState.speed,
          repeat: PlayerState.repeat,
          shuffle: PlayerState.shuffle,
          favorites: PlayerState.favorites,
          savedList: PlayerState.savedList,
          history: PlayerState.history.slice(-50)
        };
        localStorage.setItem('playerState', JSON.stringify(toSave));
      };

      const loadState = () => {
        const saved = localStorage.getItem('playerState');
        if (saved) {
          try {
            const data = JSON.parse(saved);
            PlayerState.episode = data.episode || defaultEpisode;
            PlayerState.currentTime = data.currentTime || 0;
            PlayerState.paused = data.paused !== undefined ? data.paused : true;
            PlayerState.volume = data.volume || 0.7;
            PlayerState.speed = data.speed || 1.0;
            PlayerState.repeat = data.repeat || 'off';
            PlayerState.shuffle = data.shuffle || false;
            PlayerState.favorites = data.favorites || [];
            PlayerState.savedList = data.savedList || [];
            PlayerState.history = data.history || [];
          } catch (e) {}
        } else {
          PlayerState.episode = defaultEpisode;
        }
      };

      // Elementos de audio/video
      let audioElement = new Audio();
      let videoElement = document.createElement('video');
      videoElement.playsInline = true;
      videoElement.className = 'max-w-full max-h-full object-contain';
      let fullscreenVideo = document.createElement('video');
      fullscreenVideo.playsInline = true;
      fullscreenVideo.className = 'w-full h-full object-contain';

      const initMedia = () => {
        audioElement.volume = PlayerState.volume;
        audioElement.playbackRate = PlayerState.speed;
        videoElement.volume = PlayerState.volume;
        videoElement.playbackRate = PlayerState.speed;
        fullscreenVideo.volume = PlayerState.volume;
        fullscreenVideo.playbackRate = PlayerState.speed;

        [audioElement, videoElement, fullscreenVideo].forEach(media => {
          media.addEventListener('timeupdate', updateProgress);
          media.addEventListener('durationchange', updateDuration);
          media.addEventListener('ended', handleEnded);
        });
      };

      const getCurrentMedia = () => {
        if (PlayerState.mode === 'popout-video') return videoElement;
        if (PlayerState.mode === 'fullscreen') return fullscreenVideo;
        return audioElement;
      };

      const updateProgress = () => {
        const media = getCurrentMedia();
        if (!media) return;
        PlayerState.currentTime = media.currentTime;
        PlayerState.duration = media.duration;
        // Actualizar barras
        document.querySelectorAll('.progress-fill').forEach(el => {
          el.style.width = (media.currentTime / media.duration * 100) + '%';
        });
        document.querySelectorAll('.progress-time-current').forEach(el => el.innerText = formatTime(media.currentTime));
        document.querySelectorAll('.progress-time-total').forEach(el => el.innerText = formatTime(media.duration));

        // Actualizar letra activa
        if (PlayerState.lyricsLines.length > 0) {
          const idx = PlayerState.lyricsLines.findIndex(line => line.start <= media.currentTime && line.end > media.currentTime);
          if (idx !== PlayerState.activeLyricIndex) {
            PlayerState.activeLyricIndex = idx;
            renderLyrics();
          }
        }

        // Temporizador fin de episodio: actualizar contador si es necesario
        if (PlayerState.timer && PlayerState.timer.type === 'end') {
          PlayerState.timer.endTime = Date.now() + (PlayerState.duration - PlayerState.currentTime) * 1000;
        }
      };

      const updateDuration = () => {
        const media = getCurrentMedia();
        if (media) PlayerState.duration = media.duration;
      };

      const handleEnded = () => {
        if (PlayerState.repeat === 'one') {
          seekTo(0);
          play();
        } else if (PlayerState.repeat === 'all') {
          next();
        } else {
          next();
        }
      };

      // Control básico
      const play = () => {
        const media = getCurrentMedia();
        if (media) media.play();
        PlayerState.paused = false;
        updatePlayPauseIcons();
        saveState();
      };

      const pause = () => {
        const media = getCurrentMedia();
        if (media) media.pause();
        PlayerState.paused = true;
        updatePlayPauseIcons();
        saveState();
      };

      const togglePlay = () => PlayerState.paused ? play() : pause();

      const seekTo = (seconds) => {
        const media = getCurrentMedia();
        if (media) media.currentTime = seconds;
        PlayerState.currentTime = seconds;
      };

      // Seek con acumulación (para indicadores)
      const seekByAccumulated = (direction) => {
        const increment = 15;
        if (direction === 'forward') {
          PlayerState.seekAccumulator.forward += increment;
          if (PlayerState.seekAccumulator.timeout) clearTimeout(PlayerState.seekAccumulator.timeout);
          PlayerState.seekAccumulator.timeout = setTimeout(() => {
            const total = PlayerState.seekAccumulator.forward;
            if (total > 0) {
              seekBy(total);
              showSeekIndicator(total, 'forward');
              PlayerState.seekAccumulator.forward = 0;
            }
          }, 300);
        } else {
          PlayerState.seekAccumulator.back += increment;
          if (PlayerState.seekAccumulator.timeout) clearTimeout(PlayerState.seekAccumulator.timeout);
          PlayerState.seekAccumulator.timeout = setTimeout(() => {
            const total = PlayerState.seekAccumulator.back;
            if (total > 0) {
              seekBy(-total);
              showSeekIndicator(total, 'back');
              PlayerState.seekAccumulator.back = 0;
            }
          }, 300);
        }
      };

      const seekBy = (seconds) => {
        const media = getCurrentMedia();
        if (!media) return;
        let newTime = media.currentTime + seconds;
        if (newTime < 0) newTime = 0;
        if (newTime > PlayerState.duration) newTime = PlayerState.duration;
        seekTo(newTime);
      };

      const showSeekIndicator = (seconds, dir) => {
        const id = dir === 'forward' ? 'seek-indicator-left' : 'seek-indicator-right';
        const valSpan = dir === 'forward' ? document.getElementById('seek-value') : document.getElementById('seek-value-right');
        if (valSpan) valSpan.innerText = seconds + 's';
        const ind = document.getElementById(id);
        if (ind) {
          ind.classList.add('show');
          setTimeout(() => ind.classList.remove('show'), 800);
        }
      };

      const previous = () => {
        if (PlayerState.history.length > 1) {
          const prev = PlayerState.history[PlayerState.history.length - 2];
          loadEpisode(prev);
        } else {
          seekTo(0);
        }
      };

      const next = () => {
        if (PlayerState.playlist.length > 0) {
          const nextEp = PlayerState.playlist.shift();
          loadEpisode(nextEp);
        } else {
          alert('No hay más episodios en la cola');
        }
      };

      const loadEpisode = (ep, autoplay = true) => {
        if (!ep) return;
        if (PlayerState.episode && PlayerState.episode.id !== ep.id) {
          PlayerState.history.push(PlayerState.episode);
        }
        PlayerState.episode = ep;
        PlayerState.currentTime = 0;
        PlayerState.duration = 0;
        PlayerState.subtitlesEnabled = false;
        PlayerState.lyricsLines = [];
        PlayerState.activeLyricIndex = -1;

        if (ep.mp3) audioElement.src = ep.mp3;
        if (ep.mp4) {
          videoElement.src = ep.mp4;
          fullscreenVideo.src = ep.mp4;
        }

        // Cargar subtítulos/letra (simulado)
        if (ep.subtitlesUrl) {
          fetch(ep.subtitlesUrl).then(r => r.text()).then(parseVTT).catch(() => {});
        } else if (ep.gender === 'music') {
          PlayerState.lyricsLines = [
            { start: 0, end: 5, text: 'Esta es la primera línea de la canción...' },
            { start: 5, end: 10, text: 'Esta es la segunda línea...' },
          ];
        } else if (ep.gender === 'podcast') {
          PlayerState.lyricsLines = [
            { start: 0, end: 8, text: 'Bienvenidos al episodio de hoy...' },
            { start: 8, end: 15, text: 'Hoy hablaremos sobre inteligencia artificial...' },
          ];
        }

        updateDynamicBackground(ep.cover);
        updateMediaSession(ep);
        if (autoplay) play();
        saveState();
      };

      const parseVTT = (text) => {
        // Implementación básica (simulada)
        PlayerState.lyricsLines = []; // ...
      };

      const updateMediaSession = (ep) => {
        if ('mediaSession' in navigator) {
          navigator.mediaSession.metadata = new MediaMetadata({
            title: ep.title,
            artist: ep.author,
            album: ep.serie?.title || 'Podcast',
            artwork: [{ src: ep.cover, sizes: '512x512', type: 'image/jpeg' }]
          });
          navigator.mediaSession.setActionHandler('play', play);
          navigator.mediaSession.setActionHandler('pause', pause);
          navigator.mediaSession.setActionHandler('previoustrack', previous);
          navigator.mediaSession.setActionHandler('nexttrack', next);
          navigator.mediaSession.setActionHandler('seekbackward', (d) => seekBy(-(d.seekOffset || 15)));
          navigator.mediaSession.setActionHandler('seekforward', (d) => seekBy(d.seekOffset || 15));
        }
      };

      const updatePlayPauseIcons = () => {
        const icon = PlayerState.paused ? 'play_arrow' : 'pause';
        document.querySelectorAll('.play-pause-icon').forEach(el => el.innerText = icon);
      };

      const updateDynamicBackground = (coverUrl) => {
        const style = document.createElement('style');
        style.innerHTML = `.dynamic-bg { background: linear-gradient(135deg, #0da6f2 0%, #101c22 80%); }`;
        document.head.appendChild(style);
      };

      // Favoritos y lista guardada
      const toggleFavorite = () => {
        if (!PlayerState.episode) return;
        const id = PlayerState.episode.id;
        const idx = PlayerState.favorites.indexOf(id);
        if (idx === -1) PlayerState.favorites.push(id);
        else PlayerState.favorites.splice(idx, 1);
        updateFavIcon();
        saveState();
      };

      const toggleSavedList = () => {
        if (!PlayerState.episode) return;
        const ep = PlayerState.episode;
        const idx = PlayerState.savedList.findIndex(e => e.id === ep.id);
        if (idx === -1) PlayerState.savedList.push(ep);
        else PlayerState.savedList.splice(idx, 1);
        updateSavedIcon();
        saveState();
      };

      const updateFavIcon = () => {
        const isFav = PlayerState.favorites.includes(PlayerState.episode?.id);
        document.querySelectorAll('.fav-icon').forEach(icon => {
          icon.classList.toggle('text-red-500', isFav);
          icon.classList.toggle('fill-1', isFav);
        });
      };

      const updateSavedIcon = () => {
        const isSaved = PlayerState.savedList.some(e => e.id === PlayerState.episode?.id);
        document.querySelectorAll('.saved-icon, .bookmark-icon').forEach(icon => {
          icon.classList.toggle('text-yellow-500', isSaved);
          icon.classList.toggle('fill-1', isSaved);
        });
      };

      // Temporizador
      const startTimer = (minutes, type = 'countdown') => {
        let endTime;
        if (type === 'end') {
          const remaining = (PlayerState.duration - PlayerState.currentTime) * 1000;
          endTime = Date.now() + remaining;
        } else {
          endTime = Date.now() + minutes * 60 * 1000;
        }
        PlayerState.timer = { endTime, type };
        saveState();
        if (PlayerState.panelOpen && PlayerState.panelTab === 'timer') renderPanelContent('timer');
      };

      const cancelTimer = () => {
        PlayerState.timer = null;
        saveState();
        if (PlayerState.panelOpen && PlayerState.panelTab === 'timer') renderPanelContent('timer');
      };

      const addFiveMinutes = () => {
        if (PlayerState.timer && PlayerState.timer.type !== 'end') {
          PlayerState.timer.endTime += 5 * 60 * 1000;
          saveState();
          if (PlayerState.panelOpen && PlayerState.panelTab === 'timer') renderPanelContent('timer');
        }
      };

      // Subtítulos / Letra
      const toggleSubtitles = () => {
        PlayerState.subtitlesEnabled = !PlayerState.subtitlesEnabled;
        updateSubtitlesUI();
      };

      const updateSubtitlesUI = () => {
        // En video: overlay
        const overlay = document.getElementById('subtitles-overlay');
        if (overlay) {
          if (PlayerState.subtitlesEnabled && PlayerState.activeLyricIndex >= 0) {
            overlay.textContent = PlayerState.lyricsLines[PlayerState.activeLyricIndex]?.text || '';
            overlay.style.display = 'block';
          } else {
            overlay.style.display = 'none';
          }
        }
        // En audio: área de letra
        renderLyrics();
      };

      const renderLyrics = () => {
        const lyricsArea = document.getElementById('audio-lyrics-area');
        if (!lyricsArea) return;
        if (PlayerState.mode === 'popout-audio' && PlayerState.subtitlesEnabled && PlayerState.lyricsLines.length > 0) {
          let html = '<div class="lyrics-container px-4">';
          PlayerState.lyricsLines.forEach((line, idx) => {
            html += `<div class="lyrics-line text-2xl font-bold mb-6 ${idx === PlayerState.activeLyricIndex ? 'active' : 'text-white/30'}">${line.text}</div>`;
          });
          html += '</div>';
          lyricsArea.innerHTML = html;
          // Scroll automático
          const active = document.querySelector('.lyrics-line.active');
          if (active) active.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          lyricsArea.innerHTML = '';
        }
      };

      // Panel lateral (escritorio)
      const openPanel = (tab) => {
        if (!PlayerState.mode.startsWith('popout')) {
          setMode(PlayerState.episode?.mp4 ? 'popout-video' : 'popout-audio');
        }
        PlayerState.panelOpen = true;
        PlayerState.panelTab = tab;
        applyPanelUI();
        renderPanelContent(tab);
      };

      const closePanel = () => {
        PlayerState.panelOpen = false;
        document.getElementById('side-panel')?.style.setProperty('width', '0');
        document.getElementById('media-content')?.classList.remove('w-3/5');
      };

      const togglePanel = (tab) => {
        if (PlayerState.panelOpen && PlayerState.panelTab === tab) closePanel();
        else openPanel(tab);
      };

      const applyPanelUI = () => {
        const panel = document.getElementById('side-panel');
        const media = document.getElementById('media-content');
        if (panel && media) {
          panel.style.width = '40%';
          media.classList.add('w-3/5');
        }
      };

      const renderPanelContent = (tab) => {
        const contentDiv = document.getElementById('panel-content');
        if (!contentDiv) return;
        document.querySelectorAll('.tab-btn').forEach(btn => {
          const t = btn.dataset.panelTab;
          btn.classList.toggle('text-primary', t === tab);
          btn.classList.toggle('border-b-2', t === tab);
        });

        if (tab === 'queue') {
          contentDiv.innerHTML = `<div class="text-slate-400">Aquí se mostrarán los episodios siguientes (simulado)</div>`;
        } else if (tab === 'saved') {
          contentDiv.innerHTML = `<div class="text-sm font-medium mb-2">Favoritos (${PlayerState.favorites.length})</div><div class="text-slate-400">Lista de episodios guardados (simulado)</div>`;
        } else if (tab === 'info') {
          const ep = PlayerState.episode;
          if (ep.gender === 'music' || ep.gender === 'podcast') {
            let html = '<div class="lyrics-container">';
            PlayerState.lyricsLines.forEach((line, idx) => {
              html += `<div class="lyrics-line ${idx === PlayerState.activeLyricIndex ? 'active' : ''}">${line.text}</div>`;
            });
            html += '</div>';
            contentDiv.innerHTML = html;
          } else {
            contentDiv.innerHTML = `<div>${ep.description || 'Sin descripción'}</div>`;
          }
        } else if (tab === 'speed') {
          contentDiv.innerHTML = `
            <div class="p-2">
              <h4 class="font-medium mb-4 text-center">Velocidad</h4>
              <div class="relative">
                <div class="speed-pointer"></div>
                <div class="speed-carousel"></div>
              </div>
              <div class="flex justify-center gap-2 mt-6">
                <button class="speed-preset w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 text-sm" data-speed="0.5">0.5</button>
                <button class="speed-preset w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 text-sm" data-speed="0.75">0.75</button>
                <button class="speed-preset w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 text-sm" data-speed="1.0">1</button>
                <button class="speed-preset w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 text-sm" data-speed="1.25">1.25</button>
                <button class="speed-preset w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 text-sm" data-speed="1.5">1.5</button>
                <button class="speed-preset w-10 h-10 rounded-full bg-slate-700 hover:bg-slate-600 text-sm" data-speed="2.0">2</button>
              </div>
            </div>
          `;
          initSpeedCarousel();
        } else if (tab === 'timer') {
          renderTimerPanel(contentDiv);
        }
      };

      const renderTimerPanel = (container) => {
        if (PlayerState.timer) {
          const remaining = Math.max(0, (PlayerState.timer.endTime - Date.now()) / 1000);
          container.innerHTML = `
            <div class="text-center py-8">
              <div class="text-5xl font-bold text-primary mb-6">${formatTime(remaining)}</div>
              <button id="cancel-timer" class="bg-white text-black px-6 py-2 rounded-full font-medium mr-2">Desactivar</button>
              ${PlayerState.timer.type !== 'end' ? '<button id="add5min" class="border border-white px-6 py-2 rounded-full font-medium">+5 min</button>' : ''}
            </div>
          `;
          document.getElementById('cancel-timer')?.addEventListener('click', cancelTimer);
          document.getElementById('add5min')?.addEventListener('click', addFiveMinutes);
        } else {
          container.innerHTML = `
            <div class="p-2">
              <h4 class="font-medium mb-4">Temporizador de apagado</h4>
              <div class="space-y-2">
                ${[5,10,15,30,45,60].map(m => `<button class="timer-option block w-full text-left p-3 bg-slate-800 rounded hover:bg-slate-700" data-min="${m}">${m} minutos</button>`).join('')}
                <button class="timer-option block w-full text-left p-3 bg-slate-800 rounded hover:bg-slate-700" data-end="end">Fin del episodio</button>
              </div>
            </div>
          `;
          container.querySelectorAll('.timer-option').forEach(btn => {
            btn.addEventListener('click', () => {
              const min = btn.dataset.min;
              if (min) startTimer(parseInt(min), 'countdown');
              else if (btn.dataset.end) startTimer(0, 'end');
            });
          });
        }
      };

      const initSpeedCarousel = () => {
        const container = document.querySelector('.speed-carousel');
        if (!container) return;
        const minSpeed = 0.5;
        const maxSpeed = 2.0;
        const step = 0.05;
        const numTicks = Math.round((maxSpeed - minSpeed) / step) + 1;
        const tickWidth = 20;
        const initialSpeed = PlayerState.speed;
        let currentIndex = Math.round((initialSpeed - minSpeed) / step);

        container.innerHTML = '';
        for (let i = 0; i < numTicks; i++) {
          const speed = minSpeed + i * step;
          const tick = document.createElement('div');
          tick.className = 'speed-tick';
          tick.dataset.index = i;
          const line = document.createElement('div');
          line.className = 'line';
          tick.appendChild(line);
          if (Math.abs(speed * 2 - Math.round(speed * 2)) < 0.01) {
            tick.classList.add('major');
            const span = document.createElement('span');
            span.textContent = speed.toFixed(1);
            tick.appendChild(span);
          } else {
            tick.classList.add('minor');
          }
          container.appendChild(tick);
        }

        const sliderContainer = container.parentElement;
        const halfOffset = sliderContainer.clientWidth / 2 - tickWidth / 2;
        container.style.paddingLeft = halfOffset + 'px';
        container.style.paddingRight = halfOffset + 'px';
        container.scrollLeft = currentIndex * tickWidth;

        const updateSpeedFromScroll = () => {
          const idx = Math.round(container.scrollLeft / tickWidth);
          if (idx >= 0 && idx < numTicks) {
            currentIndex = idx;
            const speed = minSpeed + idx * step;
            PlayerState.speed = speed;
            audioElement.playbackRate = speed;
            videoElement.playbackRate = speed;
            fullscreenVideo.playbackRate = speed;
            document.querySelectorAll('#speed-btn, #fs-speed .text-sm').forEach(el => el.innerText = speed.toFixed(2) + 'x');
            document.querySelectorAll('.speed-tick .line').forEach((line, i) => {
              line.style.background = i === idx ? '#0da6f2' : '#b3b3b3';
            });
          }
        };

        container.addEventListener('scroll', () => requestAnimationFrame(updateSpeedFromScroll));
        container.addEventListener('click', (e) => {
          const tick = e.target.closest('.speed-tick');
          if (tick) {
            const idx = parseInt(tick.dataset.index);
            container.scrollTo({ left: idx * tickWidth, behavior: 'smooth' });
          }
        });

        document.querySelectorAll('.speed-preset').forEach(btn => {
          btn.addEventListener('click', () => {
            const sp = parseFloat(btn.dataset.speed);
            const idx = Math.round((sp - minSpeed) / step);
            container.scrollTo({ left: idx * tickWidth, behavior: 'smooth' });
          });
        });
        updateSpeedFromScroll();
      };

      // Cambio de vistas (escritorio)
      const setMode = (newMode) => {
        PlayerState.mode = newMode;
        document.getElementById('view-minimized')?.classList.add('hidden');
        document.getElementById('view-popout')?.classList.add('hidden');
        document.getElementById('view-fullscreen')?.classList.add('hidden');
        if (newMode === 'minimized') {
          document.getElementById('view-minimized')?.classList.remove('hidden');
          renderBottomBar('bottom-bar');
        } else if (newMode.startsWith('popout')) {
          document.getElementById('view-popout')?.classList.remove('hidden');
          renderBottomBar('popout-bottom-bar');
          const videoBtn = document.getElementById('mode-video');
          const audioBtn = document.getElementById('mode-audio');
          const hasVideo = !!PlayerState.episode?.mp4;
          const hasAudio = !!PlayerState.episode?.mp3;
          videoBtn.disabled = !hasVideo;
          audioBtn.disabled = !hasAudio;
          if (newMode === 'popout-video') {
            videoBtn.classList.add('bg-primary', 'text-white');
            audioBtn.classList.remove('bg-primary', 'text-white');
            videoElement.classList.remove('hidden');
            document.getElementById('popout-cover')?.classList.add('hidden');
            document.getElementById('fullscreen-btn')?.classList.remove('hidden');
            document.getElementById('media-content').classList.remove('flex-col', 'items-start', 'justify-end');
          } else {
            audioBtn.classList.add('bg-primary', 'text-white');
            videoBtn.classList.remove('bg-primary', 'text-white');
            videoElement.classList.add('hidden');
            document.getElementById('popout-cover')?.classList.remove('hidden');
            document.getElementById('fullscreen-btn')?.classList.add('hidden');
            document.getElementById('media-content').classList.add('flex-col', 'items-start', 'justify-end');
          }
          if (PlayerState.episode?.mp4) videoElement.src = PlayerState.episode.mp4;
          if (PlayerState.episode?.mp3) audioElement.src = PlayerState.episode.mp3;
        } else if (newMode === 'fullscreen') {
          document.getElementById('view-fullscreen')?.classList.remove('hidden');
          if (PlayerState.episode?.mp4) {
            fullscreenVideo.src = PlayerState.episode.mp4;
            fullscreenVideo.currentTime = PlayerState.currentTime;
            fullscreenVideo.classList.remove('hidden');
            document.getElementById('fullscreen-cover').classList.add('hidden');
          } else {
            fullscreenVideo.classList.add('hidden');
            document.getElementById('fullscreen-cover').src = PlayerState.episode?.cover;
            document.getElementById('fullscreen-cover').classList.remove('hidden');
          }
          if (!PlayerState.paused) fullscreenVideo.play();
          document.getElementById('fullscreen-title').innerText = PlayerState.episode?.title || '';
        }
        if (PlayerState.panelOpen) {
          applyPanelUI();
          renderPanelContent(PlayerState.panelTab);
        }
        saveState();
      };

      // Renderizado de la barra inferior (escritorio)
      const renderBottomBar = (containerId) => {
        const container = document.getElementById(containerId);
        if (!container) return;
        const ep = PlayerState.episode || defaultEpisode;
        const isFav = PlayerState.favorites.includes(ep.id);
        const isSaved = PlayerState.savedList.some(e => e.id === ep.id);
        container.innerHTML = `
          <div class="max-w-[1920px] mx-auto grid grid-cols-3 items-center h-24 px-6 gap-4 relative">
            <div class="absolute top-0 left-0 right-0 h-1 bg-slate-800 progress-container cursor-pointer group" id="progress-container">
              <div class="h-full bg-primary relative progress-fill" style="width: ${(PlayerState.currentTime/PlayerState.duration*100)||0}%">
                <div class="progress-thumb absolute right-0 top-1/2 -translate-y-1/2 w-3 h-3 bg-primary rounded-full shadow-lg opacity-0"></div>
              </div>
            </div>
            <div class="flex items-center gap-4 min-w-0">
              <div class="relative group cursor-pointer" id="cover-popout-trigger">
                <img src="${ep.cover}" class="size-14 rounded-lg object-cover border border-white/10 episode-cover">
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 rounded-lg flex items-center justify-center"><span class="material-symbols-outlined">expand_less</span></div>
              </div>
              <div class="flex flex-col min-w-0">
                <h3 class="font-medium truncate text-sm" id="title-episode">${ep.title}</h3>
                <p class="text-xs text-slate-400 truncate">${ep.author}</p>
              </div>
              <button class="p-1.5 rounded-full hover:bg-slate-800" id="add-to-list-btn" title="Añadir a lista">
                <span class="material-symbols-outlined text-xl saved-icon ${isSaved ? 'text-yellow-500 fill-1' : ''}">playlist_add</span>
              </button>
              <div class="relative group">
                <button class="p-1.5 rounded-full hover:bg-slate-800" id="more-menu-btn"><span class="material-symbols-outlined">more_vert</span></button>
                <div class="absolute bottom-full left-0 mb-2 w-48 bg-slate-900 border border-white/10 rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all p-2">
                  <div class="flex gap-1">
                    <div class="flex-1 bg-slate-800 p-2 rounded-lg flex flex-col items-center cursor-pointer" id="speed-btn-panel">
                      <span class="material-symbols-outlined text-sm">speed</span><span class="text-[10px]">Velocidad</span>
                    </div>
                    <div class="flex-1 bg-slate-800 p-2 rounded-lg flex flex-col items-center cursor-pointer" id="timer-btn-panel">
                      <span class="material-symbols-outlined text-sm">timer</span><span class="text-[10px]">Temporizador</span>
                    </div>
                  </div>
                  <hr class="border-slate-800 my-1">
                  <button class="flex items-center gap-3 px-3 py-2 text-xs hover:bg-slate-800 w-full rounded" id="download-btn"><span class="material-symbols-outlined text-sm">download</span> Descargar</button>
                  <button class="flex items-center gap-3 px-3 py-2 text-xs hover:bg-slate-800 w-full rounded" id="share-btn"><span class="material-symbols-outlined text-sm">share</span> Compartir</button>
                  <button class="flex items-center gap-3 px-3 py-2 text-xs hover:bg-slate-800 w-full rounded" id="info-btn"><span class="material-symbols-outlined text-sm">info</span> Ver info</button>
                </div>
              </div>
            </div>
            <div class="flex flex-col items-center">
              <div class="flex items-center gap-4">
                <button class="text-xs border border-slate-600 rounded px-1 py-0.5 hover:border-slate-400" id="speed-btn">${PlayerState.speed.toFixed(2)}x</button>
                <button id="prev-btn"><span class="material-symbols-outlined">skip_previous</span></button>
                <button id="back15"><span class="material-symbols-outlined">replay_10</span></button>
                <button id="playpause-btn" class="size-11 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 transition"><span class="material-symbols-outlined text-3xl play-pause-icon">${PlayerState.paused ? 'play_arrow' : 'pause'}</span></button>
                <button id="forward15"><span class="material-symbols-outlined">forward_10</span></button>
                <button id="next-btn"><span class="material-symbols-outlined">skip_next</span></button>
                <button id="repeat-btn"><span class="material-symbols-outlined">${PlayerState.repeat === 'one' ? 'repeat_one' : PlayerState.repeat === 'all' ? 'repeat' : 'repeat'}</span></button>
              </div>
            </div>
            <div class="flex items-center justify-end gap-1">
              <button class="p-2 hover:bg-slate-800 rounded-full" id="fav-btn">
                <span class="material-symbols-outlined fav-icon ${isFav ? 'text-red-500 fill-1' : ''}">favorite</span>
              </button>
              <button class="p-2 hover:bg-slate-800 rounded-full" id="timer-btn"><span class="material-symbols-outlined">timer</span></button>
              <button class="p-2 hover:bg-slate-800 rounded-full" id="cc-btn"><span class="material-symbols-outlined">${ep.gender === 'music' ? 'mic' : ep.gender === 'podcast' ? 'closed_caption' : 'info'}</span></button>
              <button class="p-2 hover:bg-slate-800 rounded-full" id="queue-btn"><span class="material-symbols-outlined">queue_music</span></button>
              <button class="p-2 hover:bg-slate-800 rounded-full" id="saved-btn"><span class="material-symbols-outlined bookmark-icon ${isSaved ? 'text-yellow-500 fill-1' : ''}">bookmark</span></button>
              <div class="flex items-center volume-hover ml-2 pl-2 border-l border-slate-800">
                <button class="p-2" id="volume-btn"><span class="material-symbols-outlined">${PlayerState.volume === 0 ? 'volume_off' : 'volume_up'}</span></button>
                <div class="volume-slider flex items-center px-2">
                  <div class="h-1 w-full bg-slate-700 rounded-full overflow-hidden relative" style="width: 80px;">
                    <div class="h-full bg-slate-300" style="width: ${PlayerState.volume*100}%;" id="volume-fill"></div>
                    <input type="range" min="0" max="1" step="0.01" value="${PlayerState.volume}" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" id="volume-range">
                  </div>
                </div>
              </div>
              <button class="p-2 ml-2 hover:text-primary rounded-lg" id="popout-btn"><span class="material-symbols-outlined">picture_in_picture_alt</span></button>
            </div>
          </div>
        `;
        attachBottomBarEvents(containerId);
      };

      const attachBottomBarEvents = (containerId) => {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.querySelector('#playpause-btn')?.addEventListener('click', togglePlay);
        container.querySelector('#prev-btn')?.addEventListener('click', previous);
        container.querySelector('#next-btn')?.addEventListener('click', next);
        container.querySelector('#back15')?.addEventListener('click', () => seekByAccumulated('back'));
        container.querySelector('#forward15')?.addEventListener('click', () => seekByAccumulated('forward'));
        container.querySelector('#repeat-btn')?.addEventListener('click', cycleRepeat);
        container.querySelector('#speed-btn')?.addEventListener('click', () => togglePanel('speed'));
        container.querySelector('#timer-btn')?.addEventListener('click', () => togglePanel('timer'));
        container.querySelector('#queue-btn')?.addEventListener('click', () => togglePanel('queue'));
        container.querySelector('#saved-btn')?.addEventListener('click', () => togglePanel('saved'));
        container.querySelector('#cc-btn')?.addEventListener('click', () => {
          if (PlayerState.episode?.gender === 'false') togglePanel('info');
          else toggleSubtitles();
        });
        container.querySelector('#fav-btn')?.addEventListener('click', toggleFavorite);
        container.querySelector('#add-to-list-btn')?.addEventListener('click', toggleSavedList);
        container.querySelector('#popout-btn')?.addEventListener('click', () => {
          if (PlayerState.mode.startsWith('popout')) setMode('minimized');
          else setMode(PlayerState.episode?.mp4 ? 'popout-video' : 'popout-audio');
        });
        container.querySelector('#cover-popout-trigger')?.addEventListener('click', () => {
          if (PlayerState.mode.startsWith('popout')) setMode('minimized');
          else setMode(PlayerState.episode?.mp4 ? 'popout-video' : 'popout-audio');
        });
        container.querySelector('#speed-btn-panel')?.addEventListener('click', () => togglePanel('speed'));
        container.querySelector('#timer-btn-panel')?.addEventListener('click', () => togglePanel('timer'));
        container.querySelector('#download-btn')?.addEventListener('click', () => {
          if (PlayerState.episode?.mp3) window.open(PlayerState.episode.mp3, '_blank');
        });
        container.querySelector('#share-btn')?.addEventListener('click', () => {
          if (PlayerState.episode?.detailsUrl) navigator.clipboard?.writeText(PlayerState.episode.detailsUrl);
        });
        container.querySelector('#info-btn')?.addEventListener('click', () => togglePanel('info'));
        container.querySelector('#progress-container')?.addEventListener('click', (e) => {
          const rect = e.currentTarget.getBoundingClientRect();
          const percent = (e.clientX - rect.left) / rect.width;
          seekTo(percent * PlayerState.duration);
        });
        const volRange = container.querySelector('#volume-range');
        if (volRange) {
          volRange.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            PlayerState.volume = val;
            audioElement.volume = val;
            videoElement.volume = val;
            fullscreenVideo.volume = val;
            container.querySelector('#volume-fill').style.width = (val * 100) + '%';
          });
        }
      };

      const cycleRepeat = () => {
        const states = ['off', 'one', 'all'];
        const idx = states.indexOf(PlayerState.repeat);
        PlayerState.repeat = states[(idx + 1) % states.length];
        document.querySelectorAll('#repeat-btn .material-symbols-outlined').forEach(icon => {
          icon.innerText = PlayerState.repeat === 'one' ? 'repeat_one' : 'repeat';
        });
        saveState();
      };

      // Construcción del HTML (escritorio + móvil)
      const buildPlayerHTML = () => {
        return `
          <!-- Vista minimizada (escritorio) -->
          <div id="view-minimized" class="desktop-only flex-1 flex flex-col relative">
            <div class="flex-1 p-8 overflow-auto opacity-30 pointer-events-none">
              <h1 class="text-4xl font-bold mb-6">Explora nuevos episodios</h1>
              <div class="grid grid-cols-3 gap-4">
                <div class="h-40 bg-slate-800 rounded-2xl"></div><div class="h-40 bg-slate-800 rounded-2xl"></div><div class="h-40 bg-slate-800 rounded-2xl"></div>
              </div>
            </div>
            <div id="bottom-bar" class="glass-dark border-t border-white/10 absolute bottom-0 left-0 right-0 z-50"></div>
          </div>

          <!-- Vista pop-out (escritorio) -->
          <div id="view-popout" class="desktop-only hidden flex-1 flex-col absolute inset-0 z-40">
            <header class="flex items-center justify-between px-6 h-14 glass border-b border-white/10">
              <button id="close-popout" class="p-2 hover:bg-white/10 rounded-lg"><span class="material-symbols-outlined">expand_more</span></button>
              <div class="flex bg-black/40 p-1 rounded-full">
                <button id="mode-video" class="flex items-center gap-1 px-4 py-1 rounded-full text-sm font-bold transition-all"><span class="material-symbols-outlined text-lg">videocam</span> Video</button>
                <button id="mode-audio" class="flex items-center gap-1 px-4 py-1 rounded-full text-sm font-bold transition-all"><span class="material-symbols-outlined text-lg">audiotrack</span> Audio</button>
              </div>
              <div class="w-10"></div>
            </header>
            <div id="popout-main" class="flex-1 flex relative">
              <div id="media-content" class="media-content w-full h-full flex items-center justify-center relative transition-all duration-300">
                <video id="popout-video" class="max-w-full max-h-full object-contain hidden" playsinline></video>
                <img id="popout-cover" class="max-w-full max-h-full object-contain rounded-2xl shadow-2xl hidden" alt="cover">
                <div id="subtitles-overlay" class="subtitles-overlay hidden"></div>
                <button id="fullscreen-btn" class="absolute bottom-4 right-4 p-3 bg-black/40 hover:bg-black/60 rounded-lg border border-white/20 z-10 hidden"><span class="material-symbols-outlined">fullscreen</span></button>
                <!-- Área de letra para audio (se inyecta aquí) -->
                <div id="audio-lyrics-area" class="absolute inset-0 flex items-center justify-end pointer-events-none"></div>
              </div>
              <div id="side-panel" class="side-panel w-0 bg-black/60 backdrop-blur-xl border-l border-white/10 overflow-hidden transition-all duration-300">
                <div class="h-full flex flex-col p-4">
                  <div class="flex items-center gap-3 pb-4 border-b border-white/10">
                    <img id="panel-cover" class="w-12 h-12 rounded-lg object-cover" src="${PlayerState.episode?.cover || ''}" alt="">
                    <div class="flex-1 min-w-0">
                      <div class="font-medium truncate" id="panel-title">${PlayerState.episode?.title || ''}</div>
                      <div class="text-xs text-slate-400 truncate" id="panel-author">${PlayerState.episode?.author || ''}</div>
                    </div>
                    <button id="panel-playpause" class="p-2 bg-primary rounded-full"><span class="material-symbols-outlined text-2xl play-pause-icon">${PlayerState.paused ? 'play_arrow' : 'pause'}</span></button>
                  </div>
                  <div class="flex items-center justify-between mt-2">
                    <div class="flex gap-4 text-sm font-medium">
                      <button data-panel-tab="queue" class="tab-btn text-primary border-b-2 border-primary pb-1">A continuación</button>
                      <button data-panel-tab="saved" class="tab-btn text-slate-400 pb-1">Guardados</button>
                      <button data-panel-tab="info" class="tab-btn text-slate-400 pb-1">Info/Letra</button>
                    </div>
                    <button id="close-panel" class="p-1"><span class="material-symbols-outlined">close</span></button>
                  </div>
                  <div id="panel-content" class="flex-1 overflow-y-auto mt-4 custom-scroll"></div>
                </div>
              </div>
            </div>
            <div id="popout-bottom-bar" class="glass-dark border-t border-white/10"></div>
          </div>

          <!-- Vista fullscreen (escritorio) -->
          <div id="view-fullscreen" class="desktop-only hidden fixed inset-0 z-[100] bg-black flex flex-col">
            <div class="absolute inset-0 flex items-center justify-center">
              <video id="fullscreen-video" class="w-full h-full object-contain" playsinline></video>
              <img id="fullscreen-cover" class="w-full h-full object-contain hidden" alt="">
            </div>
            <div class="absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/80 pointer-events-none"></div>
            <div class="absolute top-8 left-8 text-2xl font-bold z-10" id="fullscreen-title">${PlayerState.episode?.title || ''}</div>
            <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 flex items-center gap-6 z-20">
              <button class="text-white/70 hover:text-white text-4xl" id="fs-shuffle"><span class="material-symbols-outlined">shuffle</span></button>
              <button class="text-white text-5xl" id="fs-prev"><span class="material-symbols-outlined">skip_previous</span></button>
              <button class="text-white text-5xl" id="fs-back"><span class="material-symbols-outlined">replay_10</span></button>
              <button class="w-20 h-20 bg-primary rounded-full flex items-center justify-center text-6xl hover:scale-105 transition" id="fs-playpause"><span class="material-symbols-outlined text-6xl play-pause-icon">${PlayerState.paused ? 'play_arrow' : 'pause'}</span></button>
              <button class="text-white text-5xl" id="fs-forward"><span class="material-symbols-outlined">forward_10</span></button>
              <button class="text-white text-5xl" id="fs-next"><span class="material-symbols-outlined">skip_next</span></button>
              <button class="text-primary text-4xl" id="fs-repeat"><span class="material-symbols-outlined">${PlayerState.repeat === 'one' ? 'repeat_one' : 'repeat'}</span></button>
            </div>
            <div class="absolute bottom-8 left-0 right-0 px-8 z-20">
              <div class="flex items-center justify-between text-sm mb-2">
                <span id="fs-current">${formatTime(PlayerState.currentTime)}</span>
                <span id="fs-duration">${formatTime(PlayerState.duration)}</span>
              </div>
              <div class="relative h-1 bg-white/20 rounded-full w-full cursor-pointer" id="fs-progress-container">
                <div class="absolute top-0 left-0 h-1 bg-primary rounded-full" id="fs-progress-fill" style="width: ${(PlayerState.currentTime/PlayerState.duration*100)||0}%"></div>
              </div>
              <div class="flex items-center justify-between mt-4">
                <div class="flex gap-4">
                  <button class="flex items-center gap-1 text-white" id="fs-speed"><span class="text-sm">${PlayerState.speed.toFixed(2)}x</span><span class="material-symbols-outlined">speed</span></button>
                </div>
                <div class="flex items-center gap-6">
                  <div class="flex items-center gap-2 group/vol">
                    <button id="fs-volume-btn"><span class="material-symbols-outlined">${PlayerState.volume === 0 ? 'volume_off' : 'volume_up'}</span></button>
                    <div class="w-20 h-1 bg-white/20 rounded-full relative">
                      <div class="absolute top-0 left-0 h-1 bg-primary rounded-full" id="fs-volume-fill" style="width: ${PlayerState.volume*100}%"></div>
                      <input type="range" min="0" max="1" step="0.01" value="${PlayerState.volume}" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" id="fs-volume-range">
                    </div>
                  </div>
                  <button id="fs-exit"><span class="material-symbols-outlined">fullscreen_exit</span></button>
                </div>
              </div>
            </div>
          </div>

          <!-- ========== VISTA MÓVIL ========== -->
          <div class="mobile-only flex-1 flex flex-col relative">
            <!-- Barra inferior fija (minimizada) -->
            <div id="mobile-bottom-bar" class="glass-dark border-t border-white/10 absolute bottom-0 left-0 right-0 z-50 h-16 flex items-center px-4">
              <div class="absolute top-0 left-0 right-0 h-0.5 bg-slate-800"><div class="h-full bg-primary progress-fill-mobile" style="width: 0%"></div></div>
              <div class="flex items-center justify-between w-full">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                  <img id="mobile-cover" class="size-11 rounded-md object-cover border border-white/10" src="${PlayerState.episode?.cover || ''}" alt="">
                  <div class="flex flex-col min-w-0">
                    <h3 class="text-sm font-semibold truncate" id="mobile-title">${PlayerState.episode?.title || ''}</h3>
                    <p class="text-[11px] text-slate-400 truncate" id="mobile-author">${PlayerState.episode?.author || ''}</p>
                  </div>
                </div>
                <div class="flex items-center gap-2">
                  <button id="mobile-playpause" class="p-2"><span class="material-symbols-outlined text-3xl play-pause-icon">${PlayerState.paused ? 'play_arrow' : 'pause'}</span></button>
                  <button id="mobile-popout" class="p-2"><span class="material-symbols-outlined text-3xl">expand_less</span></button>
                </div>
              </div>
            </div>

            <!-- Pop-out móvil (ocupa toda la pantalla, se muestra al hacer clic en expand_less) -->
            <div id="mobile-popout" class="hidden fixed inset-0 z-[100] flex flex-col dynamic-bg" style="background: #101c22;">
              <header class="flex items-center justify-between px-4 h-14 glass border-b border-white/10">
                <button id="mobile-close-popout" class="p-2"><span class="material-symbols-outlined text-3xl">expand_more</span></button>
                <div class="flex bg-black/40 p-1 rounded-full">
                  <button id="mobile-mode-video" class="px-4 py-1 rounded-full text-xs font-bold">Video</button>
                  <button id="mobile-mode-audio" class="px-4 py-1 rounded-full text-xs font-bold bg-primary text-white">Audio</button>
                </div>
                <button id="mobile-more-menu" class="p-2"><span class="material-symbols-outlined">more_horiz</span></button>
              </header>
              <!-- Contenedor media (cuadrado) -->
              <div class="flex-1 flex flex-col items-center justify-center px-4 py-6">
                <div class="w-full max-w-[400px] aspect-square rounded-2xl overflow-hidden shadow-2xl border border-white/5 relative" id="mobile-media-container">
                  <video id="mobile-video" class="w-full h-full object-cover hidden" playsinline></video>
                  <img id="mobile-cover-big" class="w-full h-full object-cover" src="${PlayerState.episode?.cover || ''}" alt="">
                  <div id="mobile-subtitles-overlay" class="absolute bottom-4 left-0 right-0 text-center text-white text-shadow hidden"></div>
                  <button id="mobile-fullscreen" class="absolute bottom-2 right-2 p-2 bg-black/40 rounded-lg hidden"><span class="material-symbols-outlined">fullscreen</span></button>
                </div>
                <!-- Área de letra para audio (cuando está activa, reemplaza el cover) -->
                <div id="mobile-lyrics-area" class="w-full max-w-[400px] mt-4 hidden"></div>
              </div>
              <!-- Metadatos y controles -->
              <div class="px-4 pb-8">
                <div class="flex items-center justify-between mb-2">
                  <div class="min-w-0">
                    <h2 class="text-xl font-bold truncate" id="mobile-big-title">${PlayerState.episode?.title || ''}</h2>
                    <p class="text-base text-slate-400 truncate" id="mobile-big-author">${PlayerState.episode?.author || ''}</p>
                  </div>
                  <button id="mobile-fav" class="p-2"><span class="material-symbols-outlined fav-icon ${PlayerState.favorites.includes(PlayerState.episode?.id) ? 'text-red-500 fill-1' : ''}">favorite</span></button>
                </div>
                <div class="mb-4">
                  <div class="relative h-1.5 w-full bg-slate-700/50 rounded-full mb-1">
                    <div class="absolute top-0 left-0 h-full bg-primary rounded-full progress-fill-mobile" style="width: ${(PlayerState.currentTime/PlayerState.duration*100)||0}%"></div>
                  </div>
                  <div class="flex justify-between text-xs text-slate-500">
                    <span class="progress-time-current">${formatTime(PlayerState.currentTime)}</span>
                    <span class="progress-time-total">${formatTime(PlayerState.duration)}</span>
                  </div>
                </div>
                <div class="flex items-center justify-between mb-6">
                  <button id="mobile-speed" class="text-xs border border-slate-600 rounded px-2 py-1">${PlayerState.speed.toFixed(2)}x</button>
                  <div class="flex items-center gap-4">
                    <button id="mobile-back15"><span class="material-symbols-outlined text-3xl">replay_10</span></button>
                    <button id="mobile-prev"><span class="material-symbols-outlined text-3xl">skip_previous</span></button>
                    <button id="mobile-playpause-big" class="size-14 rounded-full bg-white text-black flex items-center justify-center"><span class="material-symbols-outlined text-4xl play-pause-icon">${PlayerState.paused ? 'play_arrow' : 'pause'}</span></button>
                    <button id="mobile-next"><span class="material-symbols-outlined text-3xl">skip_next</span></button>
                    <button id="mobile-forward15"><span class="material-symbols-outlined text-3xl">forward_10</span></button>
                  </div>
                  <button id="mobile-repeat"><span class="material-symbols-outlined">${PlayerState.repeat === 'one' ? 'repeat_one' : 'repeat'}</span></button>
                </div>
                <div class="flex justify-around">
                  <button id="mobile-timer" class="flex flex-col items-center text-slate-400"><span class="material-symbols-outlined">timer</span></button>
                  <button id="mobile-cc" class="flex flex-col items-center text-slate-400"><span class="material-symbols-outlined">${PlayerState.episode?.gender === 'music' ? 'mic' : PlayerState.episode?.gender === 'podcast' ? 'closed_caption' : 'info'}</span></button>
                  <button id="mobile-queue" class="flex flex-col items-center text-slate-400"><span class="material-symbols-outlined">queue_music</span></button>
                  <button id="mobile-share" class="flex flex-col items-center text-slate-400"><span class="material-symbols-outlined">share</span></button>
                  <button id="mobile-saved" class="flex flex-col items-center text-slate-400"><span class="material-symbols-outlined bookmark-icon ${PlayerState.savedList.some(e => e.id === PlayerState.episode?.id) ? 'text-yellow-500 fill-1' : ''}">bookmark</span></button>
                </div>
              </div>
              <!-- Indicador de arrastre -->
              <div class="flex justify-center pb-2"><div class="w-12 h-1 bg-white/20 rounded-full"></div></div>
            </div>

            <!-- Panel móvil (para tres puntos, velocidad, temporizador, etc.) -->
            <div id="mobile-panel" class="hidden fixed inset-0 z-[110] bg-black/90 backdrop-blur-xl flex flex-col">
              <div class="flex items-center justify-between p-4 border-b border-white/10">
                <div class="flex items-center gap-3">
                  <img id="panel-mobile-cover" class="w-10 h-10 rounded-lg object-cover" src="${PlayerState.episode?.cover || ''}" alt="">
                  <div>
                    <div class="font-medium text-sm">${PlayerState.episode?.title || ''}</div>
                    <div class="text-xs text-slate-400">${PlayerState.episode?.author || ''}</div>
                  </div>
                </div>
                <button id="mobile-panel-playpause" class="p-2"><span class="material-symbols-outlined text-3xl play-pause-icon">${PlayerState.paused ? 'play_arrow' : 'pause'}</span></button>
              </div>
              <div class="flex-1 overflow-y-auto p-4" id="mobile-panel-content">
                <!-- Aquí se inyecta el contenido según la opción elegida -->
              </div>
              <div class="p-4 border-t border-white/10 flex justify-end">
                <button id="mobile-panel-close" class="px-4 py-2 bg-slate-800 rounded-lg">Cerrar</button>
              </div>
            </div>
          </div>

          <!-- Indicadores de avance/retroceso (compartidos) -->
          <div id="seek-indicator-left" class="seek-indicator left-10"><span class="material-symbols-outlined">forward_10</span> <span id="seek-value">0s</span></div>
          <div id="seek-indicator-right" class="seek-indicator right-10"><span class="material-symbols-outlined">replay_10</span> <span id="seek-value-right">0s</span></div>
        `;
      };

      // Inicialización
      const init = () => {
        loadState();
        document.getElementById('player-root').innerHTML = buildPlayerHTML();
        initMedia();
        setMode('minimized');
        loadEpisode(PlayerState.episode, !PlayerState.paused);

        // Eventos globales (escritorio)
        document.getElementById('close-popout')?.addEventListener('click', () => setMode('minimized'));
        document.getElementById('mode-video')?.addEventListener('click', () => setMode('popout-video'));
        document.getElementById('mode-audio')?.addEventListener('click', () => setMode('popout-audio'));
        document.getElementById('fullscreen-btn')?.addEventListener('click', () => setMode('fullscreen'));
        document.getElementById('fs-exit')?.addEventListener('click', () => setMode('popout-video'));
        document.getElementById('close-panel')?.addEventListener('click', closePanel);
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const tab = e.target.dataset.panelTab;
            PlayerState.panelTab = tab;
            renderPanelContent(tab);
          });
        });
        document.getElementById('panel-playpause')?.addEventListener('click', togglePlay);
        document.getElementById('fs-playpause')?.addEventListener('click', togglePlay);
        document.getElementById('fs-prev')?.addEventListener('click', previous);
        document.getElementById('fs-next')?.addEventListener('click', next);
        document.getElementById('fs-back')?.addEventListener('click', () => seekByAccumulated('back'));
        document.getElementById('fs-forward')?.addEventListener('click', () => seekByAccumulated('forward'));
        document.getElementById('fs-repeat')?.addEventListener('click', cycleRepeat);
        document.getElementById('fs-shuffle')?.addEventListener('click', () => PlayerState.shuffle = !PlayerState.shuffle);
        document.getElementById('fs-speed')?.addEventListener('click', () => togglePanel('speed'));
        const fsProgress = document.getElementById('fs-progress-container');
        if (fsProgress) {
          fsProgress.addEventListener('click', (e) => {
            const rect = fsProgress.getBoundingClientRect();
            const percent = (e.clientX - rect.left) / rect.width;
            seekTo(percent * PlayerState.duration);
          });
        }
        const fsVolume = document.getElementById('fs-volume-range');
        if (fsVolume) {
          fsVolume.addEventListener('input', (e) => {
            const val = parseFloat(e.target.value);
            PlayerState.volume = val;
            audioElement.volume = val;
            videoElement.volume = val;
            fullscreenVideo.volume = val;
            document.getElementById('fs-volume-fill').style.width = (val * 100) + '%';
          });
        }

        // Eventos móvil
        const mobilePopout = document.getElementById('mobile-popout');
        const mobilePanel = document.getElementById('mobile-panel');
        document.getElementById('mobile-popout')?.addEventListener('click', () => {
          mobilePopout.classList.remove('hidden');
        });
        document.getElementById('mobile-close-popout')?.addEventListener('click', () => {
          mobilePopout.classList.add('hidden');
        });
        document.getElementById('mobile-more-menu')?.addEventListener('click', () => {
          // Mostrar panel con opciones (velocidad, temporizador, etc.)
          mobilePanel.classList.remove('hidden');
          renderMobilePanelContent('main');
        });
        document.getElementById('mobile-panel-close')?.addEventListener('click', () => {
          mobilePanel.classList.add('hidden');
        });

        // Sincronizar estados con la vista móvil
        setInterval(() => {
          if (window.innerWidth <= 768) {
            // Actualizar barras de progreso móvil
            const percent = (PlayerState.currentTime / PlayerState.duration * 100) || 0;
            document.querySelectorAll('.progress-fill-mobile').forEach(el => el.style.width = percent + '%');
            document.querySelectorAll('#mobile-title, #mobile-big-title').forEach(el => el.innerText = PlayerState.episode?.title || '');
            document.querySelectorAll('#mobile-author, #mobile-big-author').forEach(el => el.innerText = PlayerState.episode?.author || '');
            document.getElementById('mobile-cover')?.setAttribute('src', PlayerState.episode?.cover || '');
            document.getElementById('mobile-cover-big')?.setAttribute('src', PlayerState.episode?.cover || '');
            document.getElementById('panel-mobile-cover')?.setAttribute('src', PlayerState.episode?.cover || '');
            updateFavIcon();
            updateSavedIcon();
          }
        }, 100);

        // Temporizador global
        setInterval(() => {
          if (PlayerState.timer) {
            const now = Date.now();
            if (now >= PlayerState.timer.endTime) {
              pause();
              PlayerState.timer = null;
              saveState();
              if (PlayerState.panelOpen && PlayerState.panelTab === 'timer') renderPanelContent('timer');
              if (mobilePanel && !mobilePanel.classList.contains('hidden')) renderMobilePanelContent('timer');
            } else {
              if (PlayerState.panelOpen && PlayerState.panelTab === 'timer') renderPanelContent('timer');
              if (mobilePanel && !mobilePanel.classList.contains('hidden')) renderMobilePanelContent('timer');
            }
          }
        }, 500);
      };

      // Renderizar contenido del panel móvil (simplificado)
      const renderMobilePanelContent = (section) => {
        const content = document.getElementById('mobile-panel-content');
        if (!content) return;
        if (section === 'main') {
          content.innerHTML = `
            <div class="space-y-2">
              <button class="w-full text-left p-3 bg-slate-800 rounded-lg" id="mobile-panel-speed">Velocidad</button>
              <button class="w-full text-left p-3 bg-slate-800 rounded-lg" id="mobile-panel-timer">Temporizador</button>
              <button class="w-full text-left p-3 bg-slate-800 rounded-lg" id="mobile-panel-download">Descargar</button>
              <button class="w-full text-left p-3 bg-slate-800 rounded-lg" id="mobile-panel-share">Compartir</button>
              <button class="w-full text-left p-3 bg-slate-800 rounded-lg" id="mobile-panel-info">Ver info</button>
            </div>
          `;
          document.getElementById('mobile-panel-speed')?.addEventListener('click', () => {
            // Aquí se podría abrir el carrusel de velocidad dentro del panel
            content.innerHTML = '<div class="p-2">Carrusel de velocidad (implementar)</div>';
          });
          document.getElementById('mobile-panel-timer')?.addEventListener('click', () => {
            renderTimerMobilePanel(content);
          });
        } else if (section === 'timer') {
          renderTimerMobilePanel(content);
        }
      };

      const renderTimerMobilePanel = (container) => {
        if (PlayerState.timer) {
          const remaining = Math.max(0, (PlayerState.timer.endTime - Date.now()) / 1000);
          container.innerHTML = `
            <div class="text-center py-8">
              <div class="text-5xl font-bold text-primary mb-6">${formatTime(remaining)}</div>
              <button id="mobile-cancel-timer" class="bg-white text-black px-6 py-2 rounded-full font-medium mr-2">Desactivar</button>
              ${PlayerState.timer.type !== 'end' ? '<button id="mobile-add5min" class="border border-white px-6 py-2 rounded-full font-medium">+5 min</button>' : ''}
            </div>
          `;
          document.getElementById('mobile-cancel-timer')?.addEventListener('click', cancelTimer);
          document.getElementById('mobile-add5min')?.addEventListener('click', addFiveMinutes);
        } else {
          container.innerHTML = `
            <div class="p-2">
              <h4 class="font-medium mb-4">Temporizador</h4>
              <div class="space-y-2">
                ${[5,10,15,30,45,60].map(m => `<button class="mobile-timer-option block w-full text-left p-3 bg-slate-800 rounded" data-min="${m}">${m} minutos</button>`).join('')}
                <button class="mobile-timer-option block w-full text-left p-3 bg-slate-800 rounded" data-end="end">Fin del episodio</button>
              </div>
            </div>
          `;
          document.querySelectorAll('.mobile-timer-option').forEach(btn => {
            btn.addEventListener('click', () => {
              const min = btn.dataset.min;
              if (min) startTimer(parseInt(min), 'countdown');
              else if (btn.dataset.end) startTimer(0, 'end');
            });
          });
        }
      };

      init();
    })();
  </script>
  <style>
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
  </style>
</body>
</html>
